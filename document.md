
# RAG系统需求文档

## 一、系统概述
本系统旨在构建一个支持多源数据（PDF/Word/Markdown/PPT等）的RAG（Retrieval-Augmented Generation）系统，通过LangChain框架调用Ollama大模型，结合ChromaDB向量数据库，实现文档的向量化存储、高效检索和智能问答。系统采用前后端分离架构，前端使用Streamlit构建交互界面，后端通过FastAPI提供服务接口。

---

## 二、核心需求分析

### 1. 功能需求
#### 1.1 数据处理模块
- **多格式支持**：
  - PDF：使用PyPDF2/pypdf解析文本（可选PDF解析库如pdfplumber）
  - Word：python-docx
  - Markdown：markdown库
  - PPT：python-pptx
  - TXT：直接读取
  - 其他格式：支持通过`python-docx`/`pdfplumber`等扩展
- **数据预处理**：
  - 文本清洗（去除特殊字符、空格、页眉页脚）
  - 分块处理（支持固定长度/语义分割）
  - 元数据提取（文件名、类型、作者等）

#### 1.2 向量化模块
- **嵌入模型**：
  - 使用LangChain适配Ollama模型（如`llama2`、`mistral`等）
  - 支持自定义嵌入模型（如SentenceTransformers）
- **向量存储**：
  - ChromaDB向量数据库集成
  - 支持向量维度动态适配
  - 支持向量索引优化（如HNSW、IVF-PQ）

#### 1.3 检索模块
- **相似度检索**：
  - 支持余弦相似度/欧氏距离
  - 支持Top-K结果返回
- **过滤条件**：
  - 按文件类型、时间范围、元数据等过滤

#### 1.4 问答模块
- **RAG流程**：
  1. 用户输入查询
  2. 通过嵌入模型生成查询向量
  3. 在ChromaDB中检索相关文档块
  4. 将检索结果与原始查询组合，生成最终答案
- **大模型调用**：
  - 通过LangChain调用Ollama模型
  - 支持提示词工程（Prompt Engineering）

#### 1.5 前端交互
- **Streamlit界面**：
  - 文件上传组件（支持多文件/拖拽）
  - 检索结果可视化（高亮匹配内容）
  - 问答对话框（实时显示模型输出）
  - 状态监控（处理进度/错误日志）

#### 1.6 后端服务
- **FastAPI接口**：
  - `/upload`：文件上传接口（支持多文件）
  - `/query`：问答接口（接收用户问题）
  - `/status`：系统状态监控
  - `/delete`：数据删除接口

---

### 2. 非功能需求
#### 2.1 性能要求
- 支持并发上传/查询（需评估ChromaDB和Ollama的吞吐量）
- 优化向量检索效率（使用ChromaDB的索引策略）

#### 2.2 可扩展性
- 模块化设计：支持新增文件格式/嵌入模型/向量数据库
- 配置化管理：通过YAML配置文件管理模型参数、存储路径等

#### 2.3 安全性
- 文件上传安全：限制文件类型和大小
- 数据隔离：支持多用户/项目隔离（可扩展）

#### 2.4 可维护性
- 日志系统：记录上传、检索、错误等关键操作
- 异常处理：完善错误捕获和用户提示

---

## 三、技术选型分析

| 模块          | 技术选型                           | 优势说明                          |
|---------------|------------------------------------|-----------------------------------|
| 文档解析      | PyPDF2、python-docx、pdfplumber    | 支持主流文件格式，社区活跃        |
| 嵌入模型      | Ollama + LangChain                 | 本地部署，支持多种开源模型        |
| 向量数据库    | ChromaDB                           | 简单易用，支持Python API          |
| 后端框架      | FastAPI                            | 高性能，自动生成API文档           |
| 前端框架      | Streamlit                          | 快速构建数据应用，可视化友好      |
| 数据处理      | LangChain                          | 统一的RAG工作流管理               |

---

## 四、系统架构设计

```
+-------------------+       +---------------------+       +---------------------+
|   Streamlit UI    |<----->|    FastAPI Service  |<----->|    ChromaDB         |
| (用户交互)        |       | (数据处理/接口)     |       | (向量存储)          |
+-------------------+       +---------------------+       +---------------------+
                                      ^                           |
                                      |                           v
+-------------------+       +---------------------+       +---------------------+
|  Ollama Model     |<----->|   LangChain         |<----->|   文件解析器        |
| (大模型调用)      |       | (RAG流程编排)       |       | (PDF/Word等)        |
+-------------------+       +---------------------+       +---------------------+
```

---

## 五、关键流程说明

### 1. 文件上传流程
1. 用户通过Streamlit上传文件
2. FastAPI接收文件并存储到临时目录
3. 调用文件解析器提取文本
4. 使用LangChain进行文本分块
5. 通过Ollama生成嵌入向量
6. 存入ChromaDB（包含元数据）

### 2. 问答流程
1. 用户输入查询
2. FastAPI调用Ollama生成查询向量
3. ChromaDB检索Top-K相关文档块
4. 将文档块和查询组合成提示词
5. 调用Ollama生成最终答案
6. Streamlit展示结果

---

## 六、优化建议

### 1. 性能优化
- **分块策略**：采用`RecursiveCharacterTextSplitter`实现语义分割
- **向量索引**：在ChromaDB中启用HNSW索引加速检索
- **缓存机制**：对常用查询结果进行缓存

### 2. 可靠性增强
- **重试机制**：在文件解析/向量生成失败时自动重试
- **监控告警**：通过Prometheus+Grafana监控系统状态

### 3. 扩展性设计
- **插件化架构**：通过`Entry Point`机制支持新增文件格式
- **模型热更新**：支持动态切换嵌入模型和大模型

### 4. 体验优化
- **实时预览**：在Streamlit中显示解析后的文本内容
- **结果排序**：根据相关性、时间、文件类型等多维度排序

---

## 七、风险与应对

| 风险点                 | 应对方案                          |
|------------------------|-----------------------------------|
| 复杂格式解析失败       | 增加文件格式检测和降级处理机制    |
| 向量维度不匹配         | 添加嵌入模型兼容性校验            |
| 高并发时性能下降       | 使用Redis缓存高频查询结果         |
| Ollama模型响应延迟     | 异步处理+队列系统（如Celery）     |

---

## 八、后续扩展方向

1. **多模态支持**：添加图片/表格解析能力
2. **知识图谱**：在RAG中引入实体关系抽取
3. **版本控制**：支持文档历史版本管理
4. **分布式部署**：使用Docker+Kubernetes部署

---

## 九、附录

### 1. 依赖库清单
- `fastapi`
- `streamlit`
- `langchain`
- `chromadb`
- `ollama`
- `PyPDF2` / `pdfplumber`
- `python-docx` / `python-pptx`
- `sentence-transformers` (可选)

### 2. 接口示例
```python
# FastAPI示例接口
@app.post("/upload")
async def upload_files(files: List[UploadFile]):
    # 处理文件上传逻辑
    return {"status": "success", "file_count": len(files)}
```

```python
# Streamlit示例界面
st.title("RAG问答系统")
uploaded_files = st.file_uploader("上传文件", type=["pdf", "docx", "pptx", "txt", "md"], accept_multiple_files=True)
```

---
